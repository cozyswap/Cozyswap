<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CozySwap - Decentralized Exchange</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.1/ethers.umd.min.js"></script>
    <style>
        :root {
            --primary: #6747ed;
            --primary-dark: #5a3fd6;
            --secondary: #1e1e1e;
            --background: #0f0f0f;
            --card-bg: #1a1a1a;
            --text: #ffffff;
            --text-secondary: #a0a0a0;
            --border: #2a2a2a;
            --success: #27ae60;
            --error: #e74c3c;
            --warning: #f39c12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 20px;
        }

        .logo img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .network-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--card-bg);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .network-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--success);
        }

        .wallet-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .wallet-btn:hover {
            background: var(--primary-dark);
        }

        .wallet-btn.connected {
            background: var(--success);
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .swap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .swap-title {
            font-size: 18px;
            font-weight: 600;
        }

        .token-input {
            background: var(--secondary);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 10px;
            border: 1px solid transparent;
            transition: border 0.2s;
        }

        .token-input:focus-within {
            border-color: var(--primary);
        }

        .token-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .token-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .balance {
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .balance:hover {
            color: var(--primary);
        }

        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .token-select {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--background);
            padding: 8px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            border: 1px solid var(--border);
        }

        .token-select:hover {
            background: #2a2a2a;
        }

        .token-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .token-amount {
            background: none;
            border: none;
            color: var(--text);
            font-size: 24px;
            font-weight: 600;
            width: 100%;
            text-align: right;
            outline: none;
        }

        .swap-arrow {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }

        .swap-arrow-btn {
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text);
            transition: all 0.2s;
        }

        .swap-arrow-btn:hover {
            background: var(--primary);
        }

        .slippage-settings {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .slippage-title {
            font-size: 14px;
            margin-bottom: 10px;
            color: var(--text-secondary);
        }

        .slippage-options {
            display: flex;
            gap: 10px;
        }

        .slippage-option {
            flex: 1;
            text-align: center;
            padding: 8px;
            background: var(--background);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            border: 1px solid var(--border);
        }

        .slippage-option.active {
            background: var(--primary);
            border-color: var(--primary);
        }

        .slippage-input {
            width: 100%;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            color: var(--text);
            text-align: center;
        }

        .swap-btn, .add-liquidity-btn {
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 18px;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 10px;
        }

        .swap-btn:hover:not(:disabled), .add-liquidity-btn:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .swap-btn:disabled, .add-liquidity-btn:disabled {
            background: var(--border);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .tabs {
            display: flex;
            background: var(--secondary);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 600;
        }

        .tab.active {
            background: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .pool-inputs {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stake-card {
            margin-bottom: 10px;
        }

        .stake-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stake-title {
            font-size: 16px;
            font-weight: 600;
        }

        .stake-apr {
            font-size: 14px;
            color: var(--success);
        }

        .stake-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .stake-label {
            color: var(--text-secondary);
        }

        .stake-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .stake-action-btn {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            border: none;
            color: white;
        }

        .stake-btn {
            background: var(--primary);
        }

        .unstake-btn {
            background: var(--error);
        }

        .claim-btn {
            background: var(--success);
        }

        .stake-input-container {
            margin: 10px 0;
        }

        .stake-input {
            width: 100%;
            background: var(--secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text);
            font-size: 16px;
        }

        .max-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            border: 1px solid var(--border);
        }

        .token-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .token-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .token-item:hover {
            background: var(--secondary);
        }

        .error-message {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid var(--error);
            border-radius: 12px;
            padding: 12px;
            margin-top: 15px;
            font-size: 14px;
            color: var(--error);
        }

        .success-message {
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid var(--success);
            border-radius: 12px;
            padding: 12px;
            margin-top: 15px;
            font-size: 14px;
            color: var(--success);
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 14px;
        }

        .social-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }

        .social-link {
            color: var(--text-secondary);
            text-decoration: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <img src="https://photos.pinksale.finance/file/pinksale-logo-upload/1759992605150-e3175ba3ea1d9672e44128a60a685807.JPG" alt="CozySwap Logo">
                <span>CozySwap</span>
            </div>
            <div class="network-indicator">
                <div class="network-dot"></div>
                <span>Plasma Chain</span>
            </div>
            <button class="wallet-btn" id="connectWallet">Connect Wallet</button>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="swap">Swap</div>
            <div class="tab" data-tab="liquidity">Liquidity</div>
            <div class="tab" data-tab="staking">Staking</div>
        </div>

        <!-- Swap Tab -->
        <div class="tab-content active" id="swap-tab">
            <div class="card">
                <div class="swap-header">
                    <div class="swap-title">Swap</div>
                </div>

                <div class="token-input">
                    <div class="token-row">
                        <div class="token-label">From</div>
                        <div class="balance" id="fromBalanceText">Balance: 0</div>
                    </div>
                    <div class="input-row">
                        <button class="token-select" id="selectFromToken">
                            <img class="token-icon" id="fromTokenIcon" src="https://cryptologos.cc/logos/ethereum-eth-logo.png" alt="XPL">
                            <span id="fromTokenSymbol">XPL</span>
                            <span>▼</span>
                        </button>
                        <input type="number" class="token-amount" id="fromAmount" placeholder="0.0" min="0">
                    </div>
                </div>

                <div class="swap-arrow">
                    <button class="swap-arrow-btn" id="switchTokens">↓</button>
                </div>

                <div class="token-input">
                    <div class="token-row">
                        <div class="token-label">To</div>
                        <div class="balance" id="toBalanceText">Balance: 0</div>
                    </div>
                    <div class="input-row">
                        <button class="token-select" id="selectToToken">
                            <img class="token-icon" id="toTokenIcon" src="https://photos.pinksale.finance/file/pinksale-logo-upload/1759992605150-e3175ba3ea1d9672e44128a60a685807.JPG" alt="COZY">
                            <span id="toTokenSymbol">COZY</span>
                            <span>▼</span>
                        </button>
                        <input type="number" class="token-amount" id="toAmount" placeholder="0.0" min="0" readonly>
                    </div>
                </div>

                <div class="slippage-settings">
                    <div class="slippage-title">Slippage Tolerance</div>
                    <div class="slippage-options">
                        <div class="slippage-option active" data-slippage="0.5">0.5%</div>
                        <div class="slippage-option" data-slippage="1">1%</div>
                        <div class="slippage-option" data-slippage="2">2%</div>
                    </div>
                </div>

                <button class="swap-btn" id="swapButton" disabled>Swap</button>
            </div>
        </div>

        <!-- Liquidity Tab -->
        <div class="tab-content" id="liquidity-tab">
            <div class="card">
                <div class="swap-header">
                    <div class="swap-title">Add Liquidity</div>
                </div>

                <div class="pool-inputs">
                    <div class="token-input">
                        <div class="token-row">
                            <div class="token-label">Token 1</div>
                            <div class="balance" id="token1BalanceText">Balance: 0</div>
                        </div>
                        <div class="input-row">
                            <button class="token-select" id="selectToken1">
                                <img class="token-icon" id="token1Icon" src="https://cryptologos.cc/logos/ethereum-eth-logo.png" alt="XPL">
                                <span id="token1Symbol">XPL</span>
                                <span>▼</span>
                            </button>
                            <input type="number" class="token-amount" id="token1Amount" placeholder="0.0" min="0">
                        </div>
                    </div>

                    <div class="token-input">
                        <div class="token-row">
                            <div class="token-label">Token 2</div>
                            <div class="balance" id="token2BalanceText">Balance: 0</div>
                        </div>
                        <div class="input-row">
                            <button class="token-select" id="selectToken2">
                                <img class="token-icon" id="token2Icon" src="https://photos.pinksale.finance/file/pinksale-logo-upload/1759992605150-e3175ba3ea1d9672e44128a60a685807.JPG" alt="COZY">
                                <span id="token2Symbol">COZY</span>
                                <span>▼</span>
                            </button>
                            <input type="number" class="token-amount" id="token2Amount" placeholder="0.0" min="0">
                        </div>
                    </div>
                </div>

                <button class="add-liquidity-btn" id="addLiquidityButton" disabled>Add Liquidity</button>
            </div>
        </div>

        <!-- Staking Tab -->
        <div class="tab-content" id="staking-tab">
            <div class="card stake-card">
                <div class="stake-header">
                    <div class="stake-title">COZY Staking</div>
                    <div class="stake-apr">APR: 25%</div>
                </div>
                <div class="stake-details">
                    <div class="stake-label">Your Stake:</div>
                    <div id="userStake">0 COZY</div>
                </div>
                <div class="stake-details">
                    <div class="stake-label">Pending Rewards:</div>
                    <div id="pendingRewards">0 COZY</div>
                </div>
                
                <div class="stake-input-container">
                    <label class="stake-label">Amount to Stake:</label>
                    <input type="number" class="stake-input" id="stakeAmount" placeholder="0.0" min="0">
                    <button class="max-btn" id="maxStakeBtn">MAX</button>
                </div>
                
                <div class="stake-actions">
                    <button class="stake-action-btn stake-btn" id="stakeButton">Stake</button>
                    <button class="stake-action-btn unstake-btn" id="unstakeButton">Unstake</button>
                    <button class="stake-action-btn claim-btn" id="claimButton">Claim</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>CozySwap - Decentralized Exchange on Plasma Chain</p>
            <div class="social-links">
                <a href="https://x.com/CozySwap" class="social-link" target="_blank">Twitter</a>
                <a href="https://plasmascan.to/" class="social-link" target="_blank">Explorer</a>
            </div>
        </div>
    </div>

    <!-- Token Selection Modal -->
    <div class="modal" id="tokenModal">
        <div class="modal-content">
            <div class="token-list" id="tokenList">
                <!-- Token items will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Konfigurasi
        const PLASMA_CHAIN_ID = 9745;
        const RPC_URL = 'https://rpc.plasma.to';
        const COZY_TOKEN_ADDRESS = '0x06e2ef46662834f4e42dbf9ff9222b077c57df5c';
        const ROUTER_ADDRESS = '0x89E695B38610e78a77Fb310458Dfd855505AD239';
        const STAKING_ADDRESS = '0x5Be32ac6F285e9DA3Dab9817ED15b06852a909C2';
        const WXPL_ADDRESS = '0x6100E367285b01F48D07953803A2d8dCA5D19873';

        // ABI yang lebih sederhana
        const ERC20_ABI = [
            "function balanceOf(address) view returns (uint256)",
            "function allowance(address, address) view returns (uint256)",
            "function approve(address, uint256) returns (bool)",
            "function decimals() view returns (uint8)",
            "function symbol() view returns (string)"
        ];

        const ROUTER_ABI = [
            "function getAmountsOut(uint amountIn, address[] memory path) public view returns (uint[] memory amounts)",
            "function swapExactETHForTokens(uint amountOutMin, address[] calldata path, address to, uint deadline) external payable returns (uint[] memory amounts)",
            "function swapExactTokensForETH(uint amountIn, uint amountOutMin, address[] calldata path, address to, uint deadline) external returns (uint[] memory amounts)",
            "function addLiquidityETH(address token, uint amountTokenDesired, uint amountTokenMin, uint amountETHMin, address to, uint deadline) external payable returns (uint amountToken, uint amountETH, uint liquidity)",
            "function WETH() external pure returns (address)"
        ];

        // State
        let provider, signer, userAddress;
        let cozyToken, router;
        let selectedSlippage = 0.5;

        // Tokens
        const tokens = [
            {
                address: "0x0000000000000000000000000000000000000000",
                symbol: "XPL",
                name: "Plasma Chain Native",
                decimals: 18,
                icon: "https://cryptologos.cc/logos/ethereum-eth-logo.png"
            },
            {
                address: COZY_TOKEN_ADDRESS,
                symbol: "COZY",
                name: "Cozy Token",
                decimals: 18,
                icon: "https://photos.pinksale.finance/file/pinksale-logo-upload/1759992605150-e3175ba3ea1d9672e44128a60a685807.JPG"
            }
        ];

        // Inisialisasi
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeApp();
            setupEventListeners();
        });

        async function initializeApp() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    
                    // Inisialisasi kontrak
                    cozyToken = new ethers.Contract(COZY_TOKEN_ADDRESS, ERC20_ABI, provider);
                    router = new ethers.Contract(ROUTER_ADDRESS, ROUTER_ABI, provider);
                    
                    // Cek koneksi wallet
                    const accounts = await provider.listAccounts();
                    if (accounts.length > 0) {
                        userAddress = accounts[0];
                        updateWalletButton(true);
                        await updateBalances();
                    }
                    
                    console.log("App initialized successfully");
                } else {
                    showError('Please install MetaMask');
                }
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize app: ' + error.message);
            }
        }

        function setupEventListeners() {
            // Wallet
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(`${this.dataset.tab}-tab`).classList.add('active');
                });
            });
            
            // Token selection
            document.getElementById('selectFromToken').addEventListener('click', () => openTokenModal('from'));
            document.getElementById('selectToToken').addEventListener('click', () => openTokenModal('to'));
            document.getElementById('selectToken1').addEventListener('click', () => openTokenModal('token1'));
            document.getElementById('selectToken2').addEventListener('click', () => openTokenModal('token2'));
            
            // Swap
            document.getElementById('fromAmount').addEventListener('input', calculateSwapOutput);
            document.getElementById('switchTokens').addEventListener('click', switchTokens);
            document.getElementById('swapButton').addEventListener('click', executeSwap);
            
            // Liquidity
            document.getElementById('token1Amount').addEventListener('input', updateLiquidityButton);
            document.getElementById('token2Amount').addEventListener('input', updateLiquidityButton);
            document.getElementById('addLiquidityButton').addEventListener('click', addLiquidity);
            
            // Staking
            document.getElementById('stakeButton').addEventListener('click', stakeTokens);
            document.getElementById('unstakeButton').addEventListener('click', unstakeTokens);
            document.getElementById('claimButton').addEventListener('click', claimRewards);
            document.getElementById('maxStakeBtn').addEventListener('click', setMaxStake);
            
            // Balance clicks
            document.getElementById('fromBalanceText').addEventListener('click', setMaxFromBalance);
            document.getElementById('toBalanceText').addEventListener('click', setMaxToBalance);
            document.getElementById('token1BalanceText').addEventListener('click', setMaxToken1Balance);
            document.getElementById('token2BalanceText').addEventListener('click', setMaxToken2Balance);
            
            // Slippage
            document.querySelectorAll('.slippage-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.slippage-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    selectedSlippage = parseFloat(this.dataset.slippage);
                });
            });
            
            // Modal close
            document.getElementById('tokenModal').addEventListener('click', function(e) {
                if (e.target === this) closeTokenModal();
            });
        }

        async function connectWallet() {
            try {
                if (!provider) {
                    showError('Provider not available');
                    return;
                }
                
                await provider.send("eth_requestAccounts", []);
                const accounts = await provider.listAccounts();
                userAddress = accounts[0];
                signer = provider.getSigner();
                
                // Update contracts with signer
                cozyToken = cozyToken.connect(signer);
                router = router.connect(signer);
                
                updateWalletButton(true);
                await updateBalances();
                
                showSuccess('Wallet connected!');
                
            } catch (error) {
                console.error('Wallet connection error:', error);
                showError('Failed to connect wallet: ' + error.message);
            }
        }

        async function updateBalances() {
            if (!userAddress) return;
            
            try {
                // XPL Balance
                const xplBalance = await provider.getBalance(userAddress);
                const xplFormatted = ethers.utils.formatUnits(xplBalance, 18);
                document.getElementById('fromBalanceText').textContent = `Balance: ${parseFloat(xplFormatted).toFixed(6)}`;
                document.getElementById('token1BalanceText').textContent = `Balance: ${parseFloat(xplFormatted).toFixed(6)}`;
                
                // COZY Balance
                const cozyBalance = await cozyToken.balanceOf(userAddress);
                const cozyFormatted = ethers.utils.formatUnits(cozyBalance, 18);
                document.getElementById('toBalanceText').textContent = `Balance: ${parseFloat(cozyFormatted).toFixed(6)}`;
                document.getElementById('token2BalanceText').textContent = `Balance: ${parseFloat(cozyFormatted).toFixed(6)}`;
                
                console.log("Balances updated");
                
            } catch (error) {
                console.error('Balance update error:', error);
            }
        }

        async function calculateSwapOutput() {
            const fromAmount = document.getElementById('fromAmount').value;
            const fromToken = getSelectedToken('from');
            const toToken = getSelectedToken('to');
            
            if (!fromAmount || parseFloat(fromAmount) <= 0) {
                document.getElementById('toAmount').value = '';
                document.getElementById('swapButton').disabled = true;
                return;
            }
            
            try {
                if (fromToken.symbol === 'XPL' && toToken.symbol === 'COZY') {
                    const path = [await router.WETH(), COZY_TOKEN_ADDRESS];
                    const amounts = await router.getAmountsOut(
                        ethers.utils.parseEther(fromAmount), 
                        path
                    );
                    const outputAmount = ethers.utils.formatEther(amounts[1]);
                    document.getElementById('toAmount').value = parseFloat(outputAmount).toFixed(6);
                    document.getElementById('swapButton').disabled = false;
                }
            } catch (error) {
                console.error('Swap calculation error:', error);
                document.getElementById('toAmount').value = '';
                document.getElementById('swapButton').disabled = true;
            }
        }

        async function executeSwap() {
            if (!signer) {
                showError('Wallet not connected');
                return;
            }
            
            const fromAmount = document.getElementById('fromAmount').value;
            const fromToken = getSelectedToken('from');
            const toToken = getSelectedToken('to');
            
            try {
                document.getElementById('swapButton').disabled = true;
                document.getElementById('swapButton').textContent = 'Swapping...';
                
                const deadline = Math.floor(Date.now() / 1000) + 60 * 20;
                
                if (fromToken.symbol === 'XPL' && toToken.symbol === 'COZY') {
                    const minOutput = parseFloat(document.getElementById('toAmount').value) * (1 - selectedSlippage / 100);
                    const path = [await router.WETH(), COZY_TOKEN_ADDRESS];
                    
                    const tx = await router.swapExactETHForTokens(
                        ethers.utils.parseEther(minOutput.toString()),
                        path,
                        userAddress,
                        deadline,
                        { value: ethers.utils.parseEther(fromAmount) }
                    );
                    
                    await tx.wait();
                    showSuccess('Swap successful!');
                    
                    // Reset form
                    document.getElementById('fromAmount').value = '';
                    document.getElementById('toAmount').value = '';
                    
                    await updateBalances();
                }
                
            } catch (error) {
                console.error('Swap execution error:', error);
                showError('Swap failed: ' + error.message);
            } finally {
                document.getElementById('swapButton').disabled = false;
                document.getElementById('swapButton').textContent = 'Swap';
            }
        }

        async function addLiquidity() {
            if (!signer) {
                showError('Wallet not connected');
                return;
            }
            
            const token1Amount = document.getElementById('token1Amount').value;
            const token2Amount = document.getElementById('token2Amount').value;
            const token1 = getSelectedToken('token1');
            const token2 = getSelectedToken('token2');
            
            if (!token1Amount || !token2Amount || parseFloat(token1Amount) <= 0 || parseFloat(token2Amount) <= 0) {
                showError('Please enter valid amounts');
                return;
            }
            
            try {
                console.log("Starting add liquidity...");
                document.getElementById('addLiquidityButton').disabled = true;
                document.getElementById('addLiquidityButton').textContent = 'Adding...';
                
                const deadline = Math.floor(Date.now() / 1000) + 60 * 20;
                
                // Untuk XPL-COZY pair
                if ((token1.symbol === 'XPL' && token2.symbol === 'COZY') || 
                    (token1.symbol === 'COZY' && token2.symbol === 'XPL')) {
                    
                    let xplAmount, cozyAmount;
                    if (token1.symbol === 'XPL') {
                        xplAmount = token1Amount;
                        cozyAmount = token2Amount;
                    } else {
                        xplAmount = token2Amount;
                        cozyAmount = token1Amount;
                    }
                    
                    console.log("Adding liquidity with:", xplAmount, "XPL and", cozyAmount, "COZY");
                    
                    // Approve COZY token
                    console.log("Approving COZY token...");
                    const approveTx = await cozyToken.approve(
                        ROUTER_ADDRESS,
                        ethers.utils.parseEther(cozyAmount)
                    );
                    await approveTx.wait();
                    console.log("COZY token approved");
                    
                    // Add liquidity
                    console.log("Adding liquidity...");
                    const tx = await router.addLiquidityETH(
                        COZY_TOKEN_ADDRESS,
                        ethers.utils.parseEther(cozyAmount),
                        ethers.utils.parseEther(cozyAmount) * 99 / 100, // 1% slippage
                        ethers.utils.parseEther(xplAmount) * 99 / 100, // 1% slippage
                        userAddress,
                        deadline,
                        { 
                            value: ethers.utils.parseEther(xplAmount),
                            gasLimit: 300000 
                        }
                    );
                    
                    console.log("Transaction sent:", tx.hash);
                    await tx.wait();
                    console.log("Liquidity added successfully");
                    
                    showSuccess('Liquidity added successfully!');
                    
                    // Reset form
                    document.getElementById('token1Amount').value = '';
                    document.getElementById('token2Amount').value = '';
                    
                    await updateBalances();
                }
                
            } catch (error) {
                console.error('Add liquidity error:', error);
                showError('Failed to add liquidity: ' + error.message);
            } finally {
                document.getElementById('addLiquidityButton').disabled = false;
                document.getElementById('addLiquidityButton').textContent = 'Add Liquidity';
            }
        }

        function updateLiquidityButton() {
            const token1Amount = document.getElementById('token1Amount').value;
            const token2Amount = document.getElementById('token2Amount').value;
            
            if (token1Amount && token2Amount && parseFloat(token1Amount) > 0 && parseFloat(token2Amount) > 0) {
                document.getElementById('addLiquidityButton').disabled = false;
            } else {
                document.getElementById('addLiquidityButton').disabled = true;
            }
        }

        // Fungsi bantu
        function getSelectedToken(type) {
            const symbol = document.getElementById(`${type}TokenSymbol`).textContent;
            return tokens.find(token => token.symbol === symbol);
        }

        function openTokenModal(type) {
            currentTokenSelect = type;
            const modal = document.getElementById('tokenModal');
            const tokenList = document.getElementById('tokenList');
            
            tokenList.innerHTML = '';
            tokens.forEach(token => {
                const tokenItem = document.createElement('div');
                tokenItem.className = 'token-item';
                tokenItem.innerHTML = `
                    <img class="token-icon" src="${token.icon}" alt="${token.symbol}">
                    <div>${token.symbol} - ${token.name}</div>
                `;
                tokenItem.addEventListener('click', () => selectToken(token));
                tokenList.appendChild(tokenItem);
            });
            
            modal.style.display = 'flex';
        }

        function closeTokenModal() {
            document.getElementById('tokenModal').style.display = 'none';
        }

        function selectToken(token) {
            if (currentTokenSelect) {
                document.getElementById(`${currentTokenSelect}TokenSymbol`).textContent = token.symbol;
                document.getElementById(`${currentTokenSelect}TokenIcon`).src = token.icon;
                closeTokenModal();
            }
        }

        function switchTokens() {
            const fromTokenSymbol = document.getElementById('fromTokenSymbol').textContent;
            const fromTokenIcon = document.getElementById('fromTokenIcon').src;
            const toTokenSymbol = document.getElementById('toTokenSymbol').textContent;
            const toTokenIcon = document.getElementById('toTokenIcon').src;
            
            document.getElementById('fromTokenSymbol').textContent = toTokenSymbol;
            document.getElementById('fromTokenIcon').src = toTokenIcon;
            document.getElementById('toTokenSymbol').textContent = fromTokenSymbol;
            document.getElementById('toTokenIcon').src = fromTokenIcon;
            
            document.getElementById('fromAmount').value = '';
            document.getElementById('toAmount').value = '';
        }

        function updateWalletButton(connected) {
            const button = document.getElementById('connectWallet');
            if (connected) {
                const shortAddress = userAddress.substring(0, 6) + '...' + userAddress.substring(38);
                button.textContent = shortAddress;
                button.classList.add('connected');
            } else {
                button.textContent = 'Connect Wallet';
                button.classList.remove('connected');
            }
        }

        function showError(message) {
            const existingError = document.querySelector('.error-message');
            if (existingError) existingError.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            document.querySelector('.card').appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const existingSuccess = document.querySelector('.success-message');
            if (existingSuccess) existingSuccess.remove();
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            document.querySelector('.card').appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 5000);
        }

        // Balance max functions
        function setMaxFromBalance() {
            const balanceText = document.getElementById('fromBalanceText').textContent;
            const balance = parseFloat(balanceText.split(': ')[1]);
            document.getElementById('fromAmount').value = balance;
            calculateSwapOutput();
        }

        function setMaxToBalance() {
            const balanceText = document.getElementById('toBalanceText').textContent;
            const balance = parseFloat(balanceText.split(': ')[1]);
            document.getElementById('toAmount').value = balance;
        }

        function setMaxToken1Balance() {
            const balanceText = document.getElementById('token1BalanceText').textContent;
            const balance = parseFloat(balanceText.split(': ')[1]);
            document.getElementById('token1Amount').value = balance;
            updateLiquidityButton();
        }

        function setMaxToken2Balance() {
            const balanceText = document.getElementById('token2BalanceText').textContent;
            const balance = parseFloat(balanceText.split(': ')[1]);
            document.getElementById('token2Amount').value = balance;
            updateLiquidityButton();
        }

        function setMaxStake() {
            const balanceText = document.getElementById('toBalanceText').textContent;
            const balance = parseFloat(balanceText.split(': ')[1]);
            document.getElementById('stakeAmount').value = balance;
        }

        // Staking functions (placeholder)
        async function stakeTokens() {
            showError('Staking coming soon');
        }

        async function unstakeTokens() {
            showError('Unstaking coming soon');
        }

        async function claimRewards() {
            showError('Claim rewards coming soon');
        }
    </script>
</body>
</html>